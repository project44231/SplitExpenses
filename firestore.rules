rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper to check if userId is a guest ID (starts with 'guest' or 'guest_')
    function isGuestUser(userId) {
      return userId.matches('guest(_.*)?');
    }
    
    // Helper to check if accessing own data (guest or authenticated)
    function isOwnData(userId) {
      return isGuestUser(userId) || 
             (request.auth != null && request.auth.uid == userId);
    }
    
    // Helper to check if user can create with this userId
    function canCreateAsUser(userId) {
      return isGuestUser(userId) || 
             (request.auth != null && request.auth.uid == userId);
    }
    
    // Events collection
    match /events/{eventId} {
      // Allow read if owner OR if event has a shareToken (for public sharing)
      allow read: if isOwnData(resource.data.userId) || 
                     (resource.data.shareToken != null && resource.data.shareToken != '');
      allow create: if canCreateAsUser(request.resource.data.userId);
      allow update, delete: if isOwnData(resource.data.userId);
    }
    
    // Participants collection
    match /participants/{participantId} {
      // Allow public read for participants (needed for shared event views)
      // Participants only contain names, no sensitive data
      allow read: if true;
      allow create: if canCreateAsUser(request.resource.data.userId);
      allow update, delete: if isOwnData(resource.data.userId);
    }
    
    // Expenses and Settlements
    // Allow all read/write for now (accessed via eventId from owned events)
    match /expenses/{expenseId} {
      allow read, write: if true;
    }
    
    match /settlements/{settlementId} {
      allow read, write: if true;
    }
    
    // Event groups collection
    match /event_groups/{groupId} {
      allow read: if isOwnData(resource.data.userId);
      allow create: if canCreateAsUser(request.resource.data.userId);
      allow update, delete: if isOwnData(resource.data.userId);
    }
    
    // Feedback collection - Allow guests to submit, auth users to read their own
    match /feedback/{feedbackId} {
      allow create: if request.resource.data.keys().hasAll(['userId', 'userName', 'userEmail', 'message', 'type'])
                    && request.resource.data.userName is string
                    && request.resource.data.userEmail is string
                    && request.resource.data.userEmail.matches('.*@.*')
                    && request.resource.data.message is string
                    && request.resource.data.message.size() >= 10;
      allow read: if (request.auth != null && resource.data.userId == request.auth.uid) ||
                     isGuestUser(resource.data.userId);
      allow update, delete: if false;
    }
  }
}
